{% extends "standbase/base.html" %}

{% block head %}Home{% endblock %}

{% block extrahead %}
{% endblock %}

{% block bodyid %}home{% endblock %}

{% block content %}

<div class="page-header">
	<h1>Standing <small>is an app for playful activism. <a href="#">Grab the app</a>, go outside and get standing for a cause.</small></h1>
</div>

<h2>Recent sessions</h2>

<div class="panel panel-default">
	<div class="panel-body" id="map"></div>


	{% if active_sessions %}
		{% with active_sessions.0 as session %}
			<a id="session" href="{{ session.get_absolute_url }}">
			<div class="panel-footer">
				<span class="glyphicon glyphicon-time"></span>
				<span class="livetime" id="time_{{ session.id }}">{{ session.live_duration }}</span> for <strong>{{ s.topic }}</strong> <small>in {{ session.rendered_geocode }} {{ session.datecreated|timesince }} ago</small>
			</div>
			</a>
		{% endwith %}
	{% elif completed_sessions %}
		{% with completed_sessions.0 as session %}
			<a id="session" href="{{ session.get_absolute_url }}">
			<div class="panel-footer">
				<span class="livetime" id="time_{{ session.id }}">{{ session.get_duration }}</span> for <strong>{{ session.topic }}</strong> <small>in {{ session.rendered_geocode }} {{ session.datecreated|timesince }} ago</small>
			</div>
			</a>
		{% endwith %}
	{% endif %}
</div>

<h2>Trending causes</h2>

<!-- Local Demo Code. -->
<!-- <div class="list-group">
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">World peace</h4>
		<p class="list-group-item-text">3 minutes and 14 seconds</p>
	</a>
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">Food</h4>
		<p class="list-group-item-text">1 minute and 21 seconds</p>
	</a>
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">A gulfstream jet</h4>
		<p class="list-group-item-text">49 seconds</p>
	</a>
</div> -->

<div class="list-group">
{% for topic in trending_topics %}
	<a href="{{ topic.get_absolute_url }}" class="list-group-item">
		<h4 class="list-group-item-heading">{{ topic.name|capfirst }}</h4>
		<p class="list-group-item-text">{{ topic.get_total_duration }}</p>
	</a>
{% endfor %}
</div>

{% include "standbase/footer.html" %}

{% endblock content %}

{% block extra_javascript %}
<script type="text/javascript">

	var sessions = [];

	var markers = null;

	$(document).ready(function() {
		setInterval(updateCounters, 1000);
		updateCounters();

		// Refresh the current state
		setInterval(getCurrentState, 10000);

		// We need to get the current state to seed any active sessions (not doing those from django anymore)
		getCurrentState();
	});

	/*
	 * Updates the time on the session currently in the picture if it is an active session.
	 */
	function updateCounters() {
		var id = $('.livetime').attr('id').split('_')[1];

		// Find the session belonging to this id
		var s = null;
		for (var i = 0; i < sessions.length; i++) {
			if (sessions[i]['id'] == id) {
				s = sessions[i];
			}
		}

		if (s['datefinished'] == null) {
			// This is a live session
			var secondsStood = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);

			$('.livetime').html(formatDuration(secondsStood));
		}
	}

	function listDuration(d) {
		var days = Math.floor(d / (24 * 60 * 60));
		d -= days * 24 * 60 * 60;

		var hours = Math.floor(d / (60 * 60));
		d -= hours * 60 * 60;

		var minutes = Math.floor(d / 60);
		d -= minutes * 60;

		var seconds = d;

		var returnValue = [];

		if (days > 1) {
			returnValue.push(days + " days");
		} else if (days == 1) {
			returnValue.push("1 day");
		}

		if (hours > 1) {
			returnValue.push(hours + ' hours');
		} else if (days == 1) {
			returnValue.push('1 hour');
		}

		if (minutes > 1) {
			returnValue.push(minutes + ' minutes');
		} else if (minutes == 1) {
			returnValue.push('1 minute');
		}

		if (seconds > 1) {
			returnValue.push(seconds + ' seconds');
		} else if (seconds == 1) {
			returnValue.push('1 second');
		}

		return returnValue;
	}

	function formatDuration(d) {
		var items = listDuration(d);

		var returnParts = [];

		for (var i = 0; i < items.length; i++) {
			returnParts.push(items[i]);

			if (i < items.length-2) {
				returnParts.push(', ');
			} else if (i < items.length-1) {
				returnParts.push(' and ');
			}
		}

		return returnParts.join('');
	}

	var cycleIndex = 1;

	function cycle() {
		if (sessions.length > 0) {
			if (cycleIndex > sessions.length -1) {
				cycleIndex = 0;
			}

			var s = sessions[cycleIndex];

			var activeSession = false;

			var secondsStood = 0;
			if (s['datefinished'] == null) {
				activeSession = true;
				secondsStood = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);

				console.log("Seconds stood " + secondsStood);
			} else {
				secondsStood = Math.floor((new Date(s['datefinished']) - new Date(s['datecreated'])) / 1000);
			}

			var location = "";
			if (s['parsed_geocode'] == null || (s['parsed_geocode'][0] == null && s['parsed_geocode'][1] == null)) {
				// No geocode, do nothing
			} else if (s['parsed_geocode'][0] == null) {
				location = "in " + s['parsed_geocode'][1];
			} else if (s['parsed_geocode'][1] == null) {
				location = "in " + s['parsed_geocode'][0];
			} else {
				location = "in " + s['parsed_geocode'][0] + ", " + s['parsed_geocode'][1];
			}

			var secondsAgo = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);
			var parts = listDuration(secondsAgo);
			var timeAgo = "";
			if (parts.length > 1) {
				timeAgo = parts[0] + ' and ' + parts[1];
			} else {
				timeAgo = parts[0];
			}

			// Show new session below map
			$('#session').html('<div class="panel-footer">' + (activeSession ? '<span class="glyphicon glyphicon-time"></span>' : '') + ' <span class="livetime" id="#time_' + s['id'] + '">' + formatDuration(secondsStood) + '</span> for <strong>something</strong> <small> ' + location + ' ' + timeAgo + ' ago</small></div>');
			// Set correct URL
			$('#session').attr('href', s['get_absolute_url']);


			var marker = sessions[cycleIndex]['marker'];

			map.setZoom(16);
			map.panTo(marker.getLatLng());

			cycleIndex += 1;
		}

		setTimeout(cycle, 6000);
	}

	cycle();

	function getCurrentState() {
		console.log("Getting new state");

		$.getJSON('/api/state', function(data, textStatus, jqXHR) {
			console.log(data);

			// Process incoming active sessions
			for (var i = 0; i < data['active_sessions'].length; i++) {
				var s = data['active_sessions'][i];

				sessions.push(s);
			}

			for (var i = 0; i < data['completed_sessions'].length; i++) {
				var s = data['completed_sessions'][i];

				sessions.push(s);
			}

			// Update map
			// TODO don't replace all markers, it creates a nasty stutter
			markers.clearLayers();

			for (var key in sessions) {
				var s = sessions[key];

				var marker = L.marker([s['lat'], s['lon']]);

				sessions[key]['marker'] = marker;

				markers.addLayer(marker);
			}
		});
	}

</script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />

<script src="{{ STATIC_URL }}js/leaflet/leaflet.js"></script>
<script src="{{ STATIC_URL }}js/leaflet-layer-plugins/tile/Bing.js"></script>
<script type="text/javascript">
	// initialise map
	var map = L.map('map', {
		scrollWheelZoom: false, 
		dragging: false
	});
	
	// set position and zoom level
	map.setView([46.0, 10.0], 4);

	// set bing layer
	var bing = new L.BingLayer("AuqUZRCmpMVOY8D8je-TB8URkqLGVeFx8jpFNURcbNmfeQaA-k0wW7kWIAq__HzG");
	map.addLayer(bing);

	// add markers group
	markers = new L.featureGroup();
	markers.addTo(map);

	{% if active_sessions %}
		var firstMarker = L.marker([{{ active_sessions.0.lat }}, {{ active_sessions.0.lon }}]);
	{% elif completed_sessions %}
		var firstMarker = L.marker([{{ completed_sessions.0.lat }}, {{ completed_sessions.0.lon }}]);
	{% endif %}

	markers.addLayer(firstMarker);
	map.setZoom(16);
	map.panTo(firstMarker.getLatLng());

	// if (!$.isEmptyObject(active_sessions)) {
	// 	// var map = L.map('map').setView([getActiveSession()['lat'], getActiveSession()['lon']], 13);

	// 	// L.tileLayer('http://{s}.tile.cloudmade.com/d835804aba7d4dea8039b3f6c6b8b23e/997/256/{z}/{x}/{y}.png', {
	// 	// 	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
	// 	// 	maxZoom: 18
	// 	// }).addTo(map);

	// 	// map.addLayer(bing);

	// 	var markers = [];

	// 	for (var key in active_sessions) {
	// 		var s = active_sessions[key];
	// 		markers.push(L.marker([s['lat'], s['lon']]).addTo(map));
	// 	}

	// 	var group = new L.featureGroup(markers);
	// 	map.fitBounds(group.getBounds());
	// }
</script>
{% endblock extra_javascript %}