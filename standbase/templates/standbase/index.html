{% extends "standbase/base.html" %}

{% block head %}Home{% endblock %}

{% block extrahead %}
{% endblock %}

{% block bodyid %}home{% endblock %}

{% block content %}

<div class="page-header">
	<h1>Standing <span class="label label-default">beta</span> <small>is an app for playful activism. <a href="#">Grab the app</a>, go outside and get standing for a cause.</small></h1>
</div>

<h2>Recent sessions <small><span id="active_count">{{ active_sessions|length }}</span> active sessions at the moment</small></h2>

<div id="map">
	<div id="controls">
		<a href="#" class="btn btn-primary pull-left" id="previous_button"><span class="glyphicon glyphicon-chevron-left"></span></a>
		<a href="#" class="btn btn-primary pull-right" id="next_button"><span class="glyphicon glyphicon-chevron-right"></span></a>
	</div>
</div>

<h2>Trending causes</h2>

<!-- Local Demo Code. -->
<!-- <div class="list-group">
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">World peace</h4>
		<p class="list-group-item-text">3 minutes and 14 seconds</p>
	</a>
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">Food</h4>
		<p class="list-group-item-text">1 minute and 21 seconds</p>
	</a>
	<a href="#" class="list-group-item">
		<h4 class="list-group-item-heading">A gulfstream jet</h4>
		<p class="list-group-item-text">49 seconds</p>
	</a>
</div> -->

<div class="list-group">
{% for topic in trending_topics %}
	<a href="{{ topic.get_absolute_url }}" class="list-group-item">
		<h4 class="list-group-item-heading">{{ topic.name|capfirst }}</h4>
		<p class="list-group-item-text">{{ topic.get_total_duration }}</p>
	</a>
{% endfor %}
</div>

{% include "standbase/footer.html" %}

{% endblock content %}

{% block extra_javascript %}
<script type="text/javascript">

	var sessions = [];

	var markers = null;

	$(document).ready(function() {
		$('#previous_button').click(function(e) {
			previous();
		});

		$('#next_button').click(function(e) {
			next();
		});

		// setInterval(updateCounters, 1000);

		// Refresh the current state
		setInterval(getCurrentState, 10000);

		// We need to get the current state to seed any active sessions (not doing those from django anymore)
		getCurrentState();
	});

	/*
	 * Updates the time on the session currently in the picture if it is an active session.
	 */
	function updateCounters() {
		var id = $('.livetime').attr('id').split('_')[1];

		// Find the session belonging to this id
		var s = null;
		for (var i = 0; i < sessions.length; i++) {
			if (sessions[i]['id'] == id) {
				s = sessions[i];
			}
		}

		if (s['datefinished'] == null) {
			// This is a live session
			var secondsStood = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);

			$('.livetime').html(formatDuration(secondsStood));
		}
	}

	/*
	 * Takes a duration in seconds and returns parts depending on the 
	 * units of time you can fill with them.
	 */
	function listDuration(d) {
		var days = Math.floor(d / (24 * 60 * 60));
		d -= days * 24 * 60 * 60;

		var hours = Math.floor(d / (60 * 60));
		d -= hours * 60 * 60;

		var minutes = Math.floor(d / 60);
		d -= minutes * 60;

		var seconds = d;

		var returnValue = [];

		if (days > 1) {
			returnValue.push(days + " days");
		} else if (days == 1) {
			returnValue.push("1 day");
		}

		if (hours > 1) {
			returnValue.push(hours + ' hours');
		} else if (days == 1) {
			returnValue.push('1 hour');
		}

		if (minutes > 1) {
			returnValue.push(minutes + ' minutes');
		} else if (minutes == 1) {
			returnValue.push('1 minute');
		}

		if (seconds > 1) {
			returnValue.push(seconds + ' seconds');
		} else if (seconds == 1) {
			returnValue.push('1 second');
		}

		return returnValue;
	}

	/*
	 * Formats a set of time parts into a coherent duration.
	 */
	function formatDuration(d) {
		var items = listDuration(d);

		var returnParts = [];

		for (var i = 0; i < items.length; i++) {
			returnParts.push(items[i]);

			if (i < items.length-2) {
				returnParts.push(', ');
			} else if (i < items.length-1) {
				returnParts.push(' and ');
			}
		}

		return returnParts.join('');
	}

	function getRandomArbitrary(min, max) {
		return Math.random() * (max - min) + min;
	}

	var markerIndex = 0;
	var marker = null;

	function next() {
		markerIndex += 1;

		if (sessions.length > 0 && markerIndex > sessions.length-1) {
			markerIndex = 0;
		}

		displaySession(markerIndex);
	}

	function previous() {
		markerIndex -= 1;

		if (sessions.length > 0 && markerIndex < 0) {
			markerIndex = sessions.length-1;
		}

		displaySession(markerIndex);
	}

	function displaySession(index) {
		console.log('display session with index', markerIndex);

		var s = sessions[index];

		map.removeLayer(marker);

		marker = L.marker([s['lat'], s['lon']]).addTo(map);

		console.log("New marker", marker);

		map.setZoom(16);
		map.panTo(marker.getLatLng());

		// Create and bind the popups for later

		var activeSession = false;

		var secondsStood = 0;
		if (s['datefinished'] == null) {
			activeSession = true;
			secondsStood = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);
		} else {
			secondsStood = Math.floor((new Date(s['datefinished']) - new Date(s['datecreated'])) / 1000);
		}

		var location = "";
		if (s['parsed_geocode'] == null || (s['parsed_geocode'][0] == null && s['parsed_geocode'][1] == null)) {
			// No geocode, do nothing
		} else if (s['parsed_geocode'][0] == null) {
			location = "in " + s['parsed_geocode'][1];
		} else if (s['parsed_geocode'][1] == null) {
			location = "in " + s['parsed_geocode'][0];
		} else {
			location = "in " + s['parsed_geocode'][0] + ", " + s['parsed_geocode'][1];
		}

		var secondsAgo = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);
		var parts = listDuration(secondsAgo);
		var timeAgo = "";
		if (parts.length > 1) {
			timeAgo = parts[0] + ' and ' + parts[1];
		} else {
			timeAgo = parts[0];
		}

		var popupHTML = '<p><a href="' + s['get_absolute_url'] + '">' + formatDuration(secondsStood) + ' for <strong>' + s['topic__name'] + '</strong></a> <small> ' + location + ', ' + timeAgo + ' ago</small></p>';

		var popup = L.popup({closeButton: false}).setLatLng(marker.getLatLng()).setContent(popupHTML);
		marker.bindPopup(popup);

		setTimeout(function() {
			map.openPopup(marker.getPopup());
		}, 100);
	}

	function getCurrentState() {
		console.log("Getting new state");

		$.getJSON('/api/state', function(data, textStatus, jqXHR) {
			console.log(data);

			// Process incoming active sessions
			$('#active_count').html(data['active_sessions'].length);

			for (var i = 0; i < data['active_sessions'].length; i++) {
				var s = data['active_sessions'][i];

				sessions.push(s);
			}

			for (var i = 0; i < data['completed_sessions'].length; i++) {
				var s = data['completed_sessions'][i];

				sessions.push(s);
			}
		});
	}

</script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />

<script src="{{ STATIC_URL }}js/leaflet/leaflet.js"></script>
<script src="{{ STATIC_URL }}js/leaflet-layer-plugins/tile/Bing.js"></script>
<script type="text/javascript">
	var map = L.map('map', {
		scrollWheelZoom: false, 
		// dragging: false,
		// zoomControl: false,
		attributionControl: false
	});
	
	// set position and zoom level
	map.setView([getRandomArbitrary(-90.0, 90.0), getRandomArbitrary(-180.0, 180.0)], 4);

	// set bing layer
	var bing = new L.BingLayer("AuqUZRCmpMVOY8D8je-TB8URkqLGVeFx8jpFNURcbNmfeQaA-k0wW7kWIAq__HzG");
	map.addLayer(bing);

	{% if active_sessions %}
		var marker = L.marker([{{ active_sessions.0.lat }}, {{ active_sessions.0.lon }}]).addTo(map);

		var geocode = '{{ active_sessions.0.rendered_geocode }}';
		var duration = '{{ active_sessions.0.live_duration }}';
		var url = '{{ active_sessions.0.get_absolute_url }}';
		var topic = '{{ active_sessions.0.topic.name }}';
		var timeago = '{{ active_sessions.0.datecreated|timesince }}';
	{% elif completed_sessions %}
		var marker = L.marker([{{ completed_sessions.0.lat }}, {{ completed_sessions.0.lon }}]).addTo(map);

		var geocode = '{{ completed_sessions.0.rendered_geocode }}';
		var duration = '{{ completed_sessions.0.get_duration }}';
		var url = '{{ completed_sessions.0.get_absolute_url }}';
		var topic = '{{ completed_sessions.0.topic.name }}';
		var timeago = '{{ completed_sessions.0.datecreated|timesince }}';
	{% endif %}

	map.setZoom(16);

	var popup = L.popup({closeButton: false}).setLatLng(marker.getLatLng()).setContent('<p><a href="' + url + '">' + duration + ' for <strong>' + topic + '</strong></a> <small>in ' + geocode + ', ' + timeago + '</small></p>');

	marker.bindPopup(popup);

	map.openPopup(popup);
	map.panTo(marker.getLatLng());
</script>
{% endblock extra_javascript %}