{% extends "standbase/base.html" %}

{% block head %}Now{% endblock %}

{% block extrahead %}
{% endblock %}

{% block bodyid %}now{% endblock %}

{% block content %}

<p class="label label-default">Number of people standing right now: <span id="active_count">0</span></p>

<div id="map"></div>

<ul id="active_list">
</ul>



{% include "standbase/footer.html" %}

{% endblock content %}

{% block extra_javascript %}
<script type="text/javascript">

	var markers = {};

	$(document).ready(function() {
		// Refresh the current state
		getCurrentState();
		// TODO make this refresh every two seconds
		setInterval(getCurrentState, 2000);
	});

	function getCurrentState() {
		$.getJSON('/api/state', function(data, textStatus, jqXHR) {
			console.log("Got new state:", data);

			// Process incoming active sessions
			$('#active_count').html(data['active_sessions'].length);

			if (data['active_sessions'].length > 0) {
				$('#active_count').parent().removeClass('label-default');
				$('#active_count').parent().addClass('label-danger');
			} else {
				$('#active_count').parent().removeClass('label-danger');
				$('#active_count').parent().addClass('label-default');
			}

			for (var i = 0; i < data['active_sessions'].length; i++) {
				var s = data['active_sessions'][i];

				if (markers.hasOwnProperty(s['id'])) {
					// Marker already exists
					// Do nothing
				} else {
					// Create new marker
					console.log("Creating marker for session", s);

					var marker = L.marker([s['lat'], s['lon']]).addTo(map);

					markers[s['id']] = [s, marker];

					map.panTo(marker.getLatLng());

					// And add an element to the list

					var secondsStood = Math.floor((new Date() - new Date(s['datecreated'])) / 1000);

					var location = "";
					if (s['parsed_geocode'] == null || (s['parsed_geocode'][0] == null && s['parsed_geocode'][1] == null)) {
						// No geocode, do nothing
					} else if (s['parsed_geocode'][0] == null || s['parsed_geocode'][0] == '') {
						location = "in " + s['parsed_geocode'][1];
					} else if (s['parsed_geocode'][1] == null || s['parsed_geocode'][1] == '') {
						location = "in " + s['parsed_geocode'][0];
					} else {
						location = "in " + s['parsed_geocode'][0] + ", " + s['parsed_geocode'][1];
					}

					$('#active_list').append('<li id="session_' + s['id'] + '">' + formatDuration(secondsStood) + ' for ' + s['topic__name'] + location + '</li>');
				}
			}

			// Go through markers and remove those that are no longer active
			for (var sessionId in markers) {
				var found = false;

				for (var i = 0; i < data['active_sessions'].length; i++) {
					if (data['active_sessions'][i]['id'] == sessionId) {
						found = true;
						break;
					}
				}

				if (!found) {
					map.removeLayer(markers[sessionId]);
					delete markers[sessionId];

					// Remove element from the list
					$('#session_' + sessionId).slideUp();
				}
			}

		});
	}

</script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />

<script src="{{ STATIC_URL }}js/util.js"></script>

<script src="{{ STATIC_URL }}js/leaflet/leaflet.js"></script>

<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.4"></script>

<script type="text/javascript">
	// initialise map
	var map = L.map('map', {
		// dragging: false,
		touchZoom: false,
		scrollWheelZoom: false,
		doubleClickZoom: false,
		tap: false,
		closePopupOnClick: false,
		// zoomControl: false,
		attributionControl: false
	});
	
	// set position and zoom level
	map.setView([40.0, 20.0], 4);

	var tileLayer = new L.StamenTileLayer("toner");
	map.addLayer(tileLayer);

	map.setZoom(2);
</script>
{% endblock extra_javascript %}